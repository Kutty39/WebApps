package com.blbz.webapageapp.repository;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.io.IOException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import javax.servlet.http.HttpServletRequest;

import com.blbz.webapageapp.service.WebAppDb;
import com.mysql.cj.jdbc.Blob;

public class WebAppDbActions implements WebAppDb {
	protected final String username = "appuser";
	protected final String password = "Appuser@2019";
	protected final String serverwithport = "localhost:3306";
	protected final String db = "webappDB";
	protected final String driveEngin = "mysql";

	@Override
	public boolean checkStatement(String qry) {
		System.err.println("checkStatement - Qry :" + qry);
		try (PreparedStatement stm = getConnect().prepareStatement(qry)) {
			ResultSet rs = stm.executeQuery();
			System.err.println("checkStatement - qry executed");
			return rs.next();
		} catch (SQLException e) {
			System.err.println("checkStatement - " + e.getMessage());
		}
		return false;
	}

	@Override
	public int registerUSer(String qry, HttpServletRequest request) {
		System.err.println("registerUSer - Qry :" + qry);
		try (PreparedStatement stm = getConnect().prepareStatement(qry)) {
			stm.setString(1, (String) request.getParameter("fname"));
			stm.setString(2, (String) request.getParameter("lname"));
			stm.setString(3, (String) request.getParameter("adrs"));
			stm.setString(4, (String)request.getParameter("phn"));
			stm.setString(5,encription((String)request.getParameter("pas")));
			stm.setString(6, (String) request.getParameter("eid"));
			System.err.println(stm.toString());
			int i=stm.executeUpdate();
			PreparedStatement stm1 = getConnect().prepareStatement("select user_pass from user_info");
			ResultSet rs = stm1.executeQuery();
			while(rs.next()) {
				System.err.println(encription((String)request.getParameter("pas"))==rs.getString(0));
			}
			System.err.println("registerUSer - Qry Executed");
			return i;
		} catch (SQLException e) {
			System.err.println("registerUSer - Qry error" + e.getMessage());
		} 
		return 0;
	}

	private Connection getConnect() {
		Connection con = null;
		try {
			Class.forName("com.mysql.jdbc.Driver");
			con = DriverManager.getConnection("jdbc:" + this.driveEngin + "://" + this.serverwithport + "/" + this.db,
					this.username, this.password);
			System.err.println("connection made");
		} catch (ClassNotFoundException | SQLException e) {
			System.err.println(e.getMessage());
		}
		return con;
	}
	
	private String encription(String s) {
		try {
			byte[] b= MessageDigest.getInstance("SHA256").digest(s.getBytes());
			return new String(b);
		} catch (NoSuchAlgorithmException e) {
			
			System.err.println("registerUSer - encr error "+e.getMessage());
			return "";
		}
		
	}
}
